<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airspace Layers Test - DroneScout</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1d29;
            color: white;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
        }

        button {
            background: #00d4ff;
            color: #1a1d29;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #00b8e6;
        }

        #status {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>Airspace Layer Test</h3>
        <p style="font-size: 12px; margin: 10px 0;">Testing FAA airspace polygon rendering</p>

        <label>Worker URL:</label><br>
        <input type="text" id="workerUrl" value="https://dronescout-proxy.dronescout-api.workers.dev"
               style="width: 100%; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1);
                      border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 4px;">

        <div style="margin-top: 10px;">
            <button onclick="loadChicago()">Load Chicago (O'Hare)</button>
            <button onclick="loadCrystalLake()">Load Crystal Lake</button>
            <button onclick="loadNYC()">Load NYC</button>
        </div>

        <div id="status"></div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let map;
        let airspaceLayers = {};
        let layerControl;

        // Initialize map
        function initMap(lat, lng, zoom = 12) {
            if (map) {
                map.remove();
            }

            log(`üìç Initializing map at [${lat}, ${lng}]`);

            map = L.map('map').setView([lat, lng], zoom);

            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Create empty layer groups
            airspaceLayers = {
                classB: L.layerGroup(),
                classC: L.layerGroup(),
                classD: L.layerGroup(),
                classE: L.layerGroup()
            };

            // Add layer control
            const baseMaps = {
                "OpenStreetMap": osmLayer
            };

            const overlayMaps = {
                "Class B Airspace": airspaceLayers.classB,
                "Class C Airspace": airspaceLayers.classC,
                "Class D Airspace": airspaceLayers.classD,
                "Class E Airspace": airspaceLayers.classE
            };

            if (layerControl) {
                map.removeControl(layerControl);
            }

            layerControl = L.control.layers(baseMaps, overlayMaps, {
                position: 'topright',
                collapsed: false
            }).addTo(map);

            log('‚úÖ Map initialized with layer control');

            // Load airspace data
            loadAirspaceGeometry(lat, lng);
        }

        // V13.5: Build vertical airspace profile
        function buildVerticalProfile(feature) {
            const props = feature.properties;
            const floor = props.DISTVERTLOWER_VAL;
            const ceiling = props.DISTVERTUPPER_VAL;
            const airspaceClass = props.CLASS_CODE;
            const name = props.NAME_TXT || 'Unnamed';

            const affectsPart107 = floor !== undefined && floor <= 400;
            const topOfLayer = Math.min(ceiling || 400, 400);

            let profile = `
                <div style="min-width: 250px;">
                    <h4 style="margin: 0 0 8px 0; color: #1e3c72; border-bottom: 2px solid #1e3c72; padding-bottom: 4px;">
                        üì° AIRSPACE VERTICAL PROFILE
                    </h4>
                    <div style="margin: 12px 0; padding: 10px; background: #e8f4f8; border-left: 4px solid #0066cc; border-radius: 4px;">
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px;">
                            Part 107 Operating Range (0-400 ft AGL)
                        </div>
            `;

            if (affectsPart107) {
                const color = airspaceClass === 'B' ? '#ff0000' : airspaceClass === 'C' ? '#ff00ff' : airspaceClass === 'D' ? '#0000ff' : '#00ff00';
                profile += `
                    <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid ${color};">
                        <div style="font-size: 13px; font-weight: 600;">
                            ‚úì ${floor}-${topOfLayer} ft MSL: Class ${airspaceClass}
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            ‚îî‚îÄ ${name}
                        </div>
                `;

                if (airspaceClass === 'B' || airspaceClass === 'C' || airspaceClass === 'D') {
                    profile += `<div style="font-size: 12px; color: #dc3545; margin-top: 4px; font-weight: 600;">
                        ‚îî‚îÄ ‚ö†Ô∏è Authorization Required
                    </div>`;
                }
                profile += `</div>`;

                if (ceiling && ceiling > 400) {
                    profile += `<div style="margin: 8px 0; padding: 6px; background: #f8f9fa; border-radius: 4px; font-size: 11px; color: #666;">
                        üìä ${401}-${ceiling} ft MSL: Class ${airspaceClass} (above Part 107 ceiling)
                    </div>`;
                }
            }

            profile += `
                    </div>
                    <div style="margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px;">Altitude Limits:</div>
                        <div style="font-size: 12px;">
                            Floor: <strong>${floor !== undefined ? floor : 'Unknown'} ft MSL</strong><br>
                            Ceiling: <strong>${ceiling !== undefined ? ceiling : 'Unknown'} ft MSL</strong>
                        </div>
                    </div>
            `;

            if (affectsPart107 && floor === 0) {
                profile += `
                    <div style="margin-top: 12px; padding: 10px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;">
                        <div style="color: #721c24; font-weight: 600; font-size: 13px;">
                            üö´ BLOCKS ALL DRONE OPERATIONS
                        </div>
                    </div>
                `;
            } else if (affectsPart107 && (airspaceClass === 'B' || airspaceClass === 'C' || airspaceClass === 'D')) {
                profile += `
                    <div style="margin-top: 12px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <div style="color: #856404; font-weight: 600; font-size: 13px;">
                            ‚ö†Ô∏è AUTHORIZATION REQUIRED
                        </div>
                    </div>
                `;
            }

            profile += `
                <div style="margin-top: 12px; padding: 8px; background: #e7f3ff; border-radius: 4px; font-size: 11px; color: #0066cc;">
                    ‚ÑπÔ∏è Part 107 operates 0-400 ft AGL. Check NOTAMs and TFRs before flight.
                </div>
            </div>
            `;

            return profile;
        }

        // V13.5: Calculate opacity based on floor altitude
        function getOpacityForFloor(floor) {
            if (floor === null || floor === undefined) return 0.15;
            if (floor === 0) return 0.3;
            if (floor <= 300) return 0.2;
            return 0.15;
        }

        // V13.5: Generate dynamic style
        function getStyleForFeature(airspaceClass, floor) {
            const opacity = getOpacityForFloor(floor);
            const baseStyles = {
                B: { color: '#ff0000', fillColor: '#ff0000', weight: 2 },
                C: { color: '#ff00ff', fillColor: '#ff00ff', weight: 2 },
                D: { color: '#0000ff', fillColor: '#0000ff', weight: 2 },
                E: { color: '#00ff00', fillColor: '#00ff00', weight: 1, dashArray: '5, 5' }
            };
            const style = baseStyles[airspaceClass] || baseStyles.E;
            return { ...style, fillOpacity: opacity };
        }

        async function loadAirspaceGeometry(lat, lng) {
            const workerUrl = document.getElementById('workerUrl').value;

            if (!workerUrl) {
                log('‚ùå Worker URL is required');
                return;
            }

            log('üó∫Ô∏è Loading airspace geometry...');
            log(`üìç Center: [${lat.toFixed(4)}, ${lng.toFixed(4)}], Radius: 25km`);

            const url = `${workerUrl}/api/airspace/geometry?lat=${lat}&lon=${lng}&radius=25000`;
            log(`üîó Fetching: ${url}`);

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    log(`‚ùå API error: ${response.status} ${response.statusText}`);
                    const errorText = await response.text();
                    log(`Response: ${errorText}`);
                    return;
                }

                const data = await response.json();
                log('üì¶ Received data:', JSON.stringify({
                    success: data.success,
                    count: data.count,
                    totalCount: data.totalCount,
                    excludedCount: data.excludedCount,
                    maxFloor: data.maxFloor,
                    classes: {
                        B: data.byClass?.B?.length || 0,
                        C: data.byClass?.C?.length || 0,
                        D: data.byClass?.D?.length || 0,
                        E: data.byClass?.E?.length || 0
                    }
                }));

                if (data.totalCount && data.totalCount > data.count) {
                    log(`üìä Altitude filtering: ${data.totalCount} total ‚Üí ${data.count} relevant (excluded ${data.excludedCount} features with floor > ${data.maxFloor} ft MSL)`);
                }

                if (!data.success) {
                    log(`‚ùå API returned success=false: ${data.error || data.message}`);
                    return;
                }

                if (!data.byClass) {
                    log('‚ö†Ô∏è No byClass data in response');
                    return;
                }

                // Clear existing layers
                Object.values(airspaceLayers).forEach(layer => layer.clearLayers());

                // Process each airspace class
                Object.keys(data.byClass).forEach(airspaceClass => {
                    const features = data.byClass[airspaceClass];

                    if (features.length === 0) {
                        log(`‚ö™ Class ${airspaceClass}: No features`);
                        return;
                    }

                    const layerKey = `class${airspaceClass}`;
                    const layer = airspaceLayers[layerKey];

                    if (!layer) {
                        log(`‚ùå Layer not found for class${airspaceClass}`);
                        return;
                    }

                    log(`üîµ Processing Class ${airspaceClass}: ${features.length} features`);

                    features.forEach((feature, idx) => {
                        try {
                            // V13.5: Dynamic styling based on floor altitude
                            const floor = feature.properties.DISTVERTLOWER_VAL;
                            const dynamicStyle = getStyleForFeature(airspaceClass, floor);

                            const geoJsonLayer = L.geoJSON(feature, {
                                style: dynamicStyle,
                                onEachFeature: function(feature, layer) {
                                    // V13.5: Use enhanced vertical profile popup
                                    const popupContent = buildVerticalProfile(feature);
                                    layer.bindPopup(popupContent);
                                }
                            });

                            geoJsonLayer.addTo(layer);

                            // CRITICAL: Also add the layer to the map immediately for visibility
                            if (!map.hasLayer(layer)) {
                                layer.addTo(map);
                                log(`  ‚úì Added layer to map: Class ${airspaceClass}`);
                            }

                        } catch (err) {
                            log(`  ‚ùå Error adding feature ${idx + 1}: ${err.message}`);
                        }
                    });

                    log(`‚úÖ Class ${airspaceClass}: Added ${features.length} features (layer has ${layer.getLayers().length} total layers)`);
                });

                log('‚úÖ Airspace geometry loading complete!');
                log('üí° Use the layer control (top-right) to toggle visibility');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                console.error(error);
            }
        }

        function log(message) {
            const status = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            status.innerHTML += `<div>[${time}] ${message}</div>`;
            status.scrollTop = status.scrollHeight;
            console.log(message);
        }

        function loadChicago() {
            log('--- Loading Chicago (O\'Hare) ---');
            document.getElementById('status').innerHTML = '';
            initMap(41.9742, -87.9073, 10); // O'Hare Airport
        }

        function loadCrystalLake() {
            log('--- Loading Crystal Lake, IL ---');
            document.getElementById('status').innerHTML = '';
            initMap(42.241, -88.316, 12);
        }

        function loadNYC() {
            log('--- Loading NYC ---');
            document.getElementById('status').innerHTML = '';
            initMap(40.7128, -74.0060, 10);
        }

        // Initialize with Chicago by default
        window.onload = function() {
            loadChicago();
        };
    </script>
</body>
</html>
