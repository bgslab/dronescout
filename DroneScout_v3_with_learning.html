<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroneScout - Aerial Photography Planning</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a2a6c 0%, #0f1b4d 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: #f5f7fa;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e0e6ed;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }

        .content {
            padding: 20px;
            padding-bottom: 80px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #e0e6ed;
            color: #666;
        }

        .x10-badge {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .x10-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .x10-features {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .feature-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .spot-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .spot-card:active {
            transform: scale(0.98);
        }

        .spot-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .risk-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            backdrop-filter: blur(10px);
        }

        .risk-badge.high {
            background: rgba(39, 174, 96, 0.9);
            color: white;
        }

        .risk-badge.medium {
            background: rgba(255, 193, 7, 0.9);
            color: white;
        }

        .risk-badge.low {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }

        .favorite-star {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
            backdrop-filter: blur(10px);
        }

        .favorite-star.active {
            color: #ffc107;
        }

        .favorite-star:active {
            transform: scale(0.9);
        }

        .spot-info {
            padding: 15px;
        }

        .spot-name {
            font-size: 18px;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .spot-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .spot-distance {
            font-size: 13px;
            color: #00d4ff;
            font-weight: 600;
        }

        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            margin-bottom: 10px;
        }

        .detail-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .instruction-box {
            background: #e8f4f8;
            border-left: 4px solid #00d4ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .instruction-box h4 {
            font-size: 14px;
            font-weight: 700;
            color: #0099cc;
            margin-bottom: 8px;
        }

        .instruction-box p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 12px;
        }

        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            background: #e0e6ed;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .risk-category {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .risk-cat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .risk-cat-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .risk-cat-score {
            font-size: 14px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .score-high {
            background: #d4edda;
            color: #155724;
        }

        .score-medium {
            background: #fff3cd;
            color: #856404;
        }

        .score-low {
            background: #f8d7da;
            color: #721c24;
        }

        .risk-cat-bar {
            width: 100%;
            height: 6px;
            background: #e0e6ed;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .risk-cat-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff 0%, #0099cc 100%);
            transition: width 0.3s;
        }

        .risk-cat-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .flight-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .flight-location {
            font-size: 16px;
            font-weight: 700;
            color: #1e3c72;
        }

        .flight-date {
            font-size: 13px;
            color: #666;
        }

        .flight-details {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .flight-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .btn-small {
            flex: 1;
            padding: 8px;
            background: #00d4ff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-small.secondary {
            background: #e0e6ed;
            color: #666;
        }

        .btn-small.danger {
            background: #dc3545;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 16px;
            color: #666;
        }

        .file-upload {
            border: 2px dashed #00d4ff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-upload:hover {
            background: #f0f9ff;
        }

        .file-upload input {
            display: none;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            background: #f0f9ff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-weight: 600;
        }

        .prefs-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .prefs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .prefs-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e3c72;
        }

        .prefs-toggle {
            background: none;
            border: none;
            color: #00d4ff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .slider-group {
            margin-bottom: 20px;
        }

        .slider-group:last-child {
            margin-bottom: 0;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
        }

        .slider-label.active {
            color: #00d4ff;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e6ed;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 212, 255, 0.4);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 212, 255, 0.4);
        }

        .toggle-favorites-btn {
            background: white;
            border: 2px solid #e0e6ed;
            color: #666;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-favorites-btn.active {
            background: #ffc107;
            color: white;
            border-color: #ffc107;
        }

        .map-toggle-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .map-toggle-btn {
            flex: 1;
            padding: 10px;
            background: white;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
        }

        .map-toggle-btn.active {
            background: #00d4ff;
            color: white;
            border-color: #00d4ff;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 20px;
        }

        .rating-group {
            margin-bottom: 20px;
        }

        .rating-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .star-rating {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .star {
            font-size: 32px;
            color: #e0e6ed;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star.active {
            color: #ffc107;
        }

        .star:hover {
            transform: scale(1.1);
        }

        .toggle-group {
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            background: white;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #00d4ff;
            color: white;
            border-color: #00d4ff;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 6px;
        }

        .badge.rated {
            background: #d4edda;
            color: #155724;
        }

        .badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .summary-map-container {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            background: #e0e6ed;
        }

        .map-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>🚁 DroneScout</h1>
            <p>Plan • Assess • Fly • Log</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="planner">Trip Planner</button>
            <button class="nav-tab" data-tab="upcoming">Upcoming</button>
            <button class="nav-tab" data-tab="log">History</button>
        </div>

        <div class="content" id="content">
            <!-- Content will be dynamically rendered -->
        </div>
    </div>

    <!-- Rating Modal -->
    <div class="modal" id="ratingModal">
        <div class="modal-content">
            <div class="modal-header">Rate Your Flight</div>
            <div id="ratingContent"></div>
        </div>
    </div>

    <!-- Save Flight Plan Modal -->
    <div class="modal" id="savePlanModal">
        <div class="modal-content">
            <div class="modal-header">Save Flight Plan</div>
            <div id="savePlanContent"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize app immediately when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            // App state
            const state = {
                currentTab: 'planner',
                selectedSpot: null,
                destination: '',
                spots: [],
                upcomingFlights: loadFromStorage('upcomingFlights') || [],
                flights: loadFromStorage('flights') || [],
                ratings: loadFromStorage('ratings') || [],
                showAddFlight: false,
                newFlight: { location: '', date: '', duration: '', notes: '', files: [] },
                preferences: {
                    scenicWeight: 75,
                    accessibilityWeight: 50,
                    popularityWeight: 25
                },
                showPreferences: false,
                recentSearches: loadFromStorage('recentSearches') || [],
                favorites: loadFromStorage('favorites') || [],
                showFavoritesOnly: false,
                showSummaryMap: true,
                summaryMapInstance: null,
                currentRating: null
            };

            // LocalStorage helpers
            function loadFromStorage(key) {
                try {
                    const data = localStorage.getItem('dronescout_' + key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    return null;
                }
            }

            function saveToStorage(key, value) {
                try {
                    localStorage.setItem('dronescout_' + key, JSON.stringify(value));
                } catch (e) {
                    console.error('Storage error:', e);
                }
            }

            // Demo data
            const scenicSpots = [
                {
                    id: 1,
                    name: "Constitution Trail Overlook",
                    description: "Scenic trail with open fields and tree lines. Great for tracking shots and nature content.",
                    coordinates: { lat: 40.4842, lng: -88.9936 },
                    imageUrl: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800&q=80",
                    flightInstructions: "Launch from north parking area. Fly heading 180° (south) along tree line. Maintain 150 ft AGL to capture trail and surrounding farmland. Look east for sunrise golden hour shots.",
                    bestTime: "Golden hour (sunrise/sunset)",
                    x10Advantage: "X10's advanced autonomy excels at tree line tracking. Superior range enables full trail coverage. Nightsense allows twilight flights when trails are empty.",
                    distance: "2.3 mi",
                    riskScore: 88,
                    shotTypes: { landscape: 70, nature: 30, cityscape: 0, architecture: 0 },
                    airspaceDetails: {
                        class: "Class G (Uncontrolled)",
                        ceiling: "Up to 400 ft AGL authorized",
                        laancRequired: "No",
                        gridSystem: "0-400 ft (Part 107)",
                        nearestAirport: "Central Illinois Regional (BMI) - 4.2 mi SE"
                    },
                    regulations: [
                        { authority: "FAA Part 107", rule: "Visual line of sight waived (Part 107.31) - BVLOS certified", compliant: true },
                        { authority: "Local Parks", rule: "Drone flights permitted with Part 107 certification", compliant: true },
                        { authority: "State of Illinois", rule: "No state restrictions for certified pilots", compliant: true }
                    ],
                    weatherConditions: {
                        wind: "8-12 mph SW",
                        visibility: "10+ miles",
                        temp: "72°F",
                        conditions: "Clear"
                    }
                },
                {
                    id: 2,
                    name: "Downtown Skyline - Miller Park",
                    description: "Urban skyline shots with historic buildings and modern architecture blend.",
                    coordinates: { lat: 40.4781, lng: -88.9937 },
                    imageUrl: "https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?w=800&q=80",
                    flightInstructions: "Launch from Miller Park. Fly heading 45° (northeast) toward downtown. Maintain 300 ft AGL for optimal building perspective. Look northwest for State Farm towers and courthouse dome.",
                    bestTime: "Blue hour (twilight) for city lights",
                    x10Advantage: "Nightsense capability captures stunning blue hour shots other drones miss. Elite obstacle avoidance navigates urban environment safely.",
                    distance: "3.7 mi",
                    riskScore: 72,
                    shotTypes: { cityscape: 80, architecture: 20, landscape: 0, nature: 0 },
                    airspaceDetails: {
                        class: "Class G with LAANC",
                        ceiling: "Up to 400 ft AGL with authorization",
                        laancRequired: "Yes (auto-approved up to 400 ft)",
                        gridSystem: "0-400 ft (LAANC Grid)",
                        nearestAirport: "Central Illinois Regional (BMI) - 3.8 mi SE"
                    },
                    regulations: [
                        { authority: "FAA Part 107", rule: "LAANC authorization obtained", compliant: true },
                        { authority: "City of Bloomington", rule: "Municipal approval for park launches", compliant: true },
                        { authority: "FAA", rule: "Night operations authorized with Part 107.29 waiver", compliant: true }
                    ],
                    weatherConditions: {
                        wind: "6-10 mph SSW",
                        visibility: "10+ miles",
                        temp: "68°F",
                        conditions: "Partly cloudy"
                    }
                },
                {
                    id: 3,
                    name: "Evergreen Lake Nature Preserve",
                    description: "Natural lake with wildlife and dense tree cover. Excellent for aerial shots of water reflections and park landscape.",
                    coordinates: { lat: 40.5142, lng: -88.9687 },
                    imageUrl: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80",
                    flightInstructions: "Launch from east parking area. Fly heading 270° (west) over lake. Maintain 200 ft AGL to capture full lake and fountain. Look north for pavilion and trees framing the shot.",
                    bestTime: "Early morning for calm water reflections",
                    x10Advantage: "X10 Nightsense unlocks magical twilight/blue hour shots most drones can't attempt. Advanced obstacle avoidance navigates dense canopy safely. Autonomy handles complex tree navigation.",
                    distance: "5.1 mi",
                    riskScore: 91,
                    shotTypes: { nature: 60, landscape: 40, cityscape: 0, architecture: 0 },
                    airspaceDetails: {
                        class: "Class G (Uncontrolled)",
                        ceiling: "Up to 400 ft AGL authorized",
                        laancRequired: "No",
                        gridSystem: "0-400 ft (Part 107)",
                        nearestAirport: "Central Illinois Regional (BMI) - 6.1 mi S"
                    },
                    regulations: [
                        { authority: "FAA Part 107", rule: "BVLOS operations authorized", compliant: true },
                        { authority: "McLean County", rule: "Preserve permits drone use for photography", compliant: true },
                        { authority: "Wildlife Protection", rule: "Maintain 100 ft from active nesting areas (seasonal)", compliant: true }
                    ],
                    weatherConditions: {
                        wind: "5-8 mph W",
                        visibility: "10+ miles",
                        temp: "65°F",
                        conditions: "Clear"
                    }
                },
                {
                    id: 4,
                    name: "Lake Bloomington Dam",
                    description: "Great for dramatic shots of water infrastructure and surrounding hills.",
                    coordinates: { lat: 40.5833, lng: -88.9500 },
                    imageUrl: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=800&q=80",
                    flightInstructions: "Launch from dam access road. Fly heading 90° (east) along dam face. Maintain 250 ft AGL for dramatic perspective. Look south for lake expanse and spillway action.",
                    bestTime: "Midday for water detail and shadows",
                    x10Advantage: "Superior range allows safe operation from shore while capturing dam detail. BVLOS certification enables full dam length coverage.",
                    distance: "6.8 mi",
                    riskScore: 65,
                    shotTypes: { landscape: 50, architecture: 30, nature: 20, cityscape: 0 },
                    airspaceDetails: {
                        class: "Class G (Uncontrolled)",
                        ceiling: "Up to 400 ft AGL authorized",
                        laancRequired: "No",
                        gridSystem: "0-400 ft (Part 107)",
                        nearestAirport: "Central Illinois Regional (BMI) - 8.2 mi S"
                    },
                    regulations: [
                        { authority: "FAA Part 107", rule: "BVLOS operations authorized", compliant: true },
                        { authority: "City of Bloomington Water Dept", rule: "Drone operations permitted with advance notice", compliant: true },
                        { authority: "Infrastructure Security", rule: "No flights below dam crest level", compliant: true }
                    ],
                    weatherConditions: {
                        wind: "10-14 mph NW",
                        visibility: "10+ miles",
                        temp: "70°F",
                        conditions: "Sunny"
                    }
                }
            ];

            // Calculate adjusted risk score based on learning
            function getAdjustedRiskScore(spot) {
                const baseScore = spot.riskScore;
                
                // If no ratings yet, return base score
                if (state.ratings.length === 0) return baseScore;

                // Calculate average ratings per shot type
                const shotTypeRatings = {};
                const shotTypeCounts = {};

                state.ratings.forEach(rating => {
                    const flight = state.flights.find(f => f.id === rating.flightId);
                    if (flight && flight.spotData && flight.spotData.shotTypes) {
                        // Get dominant shot type for this flight
                        const shotTypes = flight.spotData.shotTypes;
                        const dominantType = Object.keys(shotTypes).reduce((a, b) => 
                            shotTypes[a] > shotTypes[b] ? a : b
                        );

                        if (!shotTypeRatings[dominantType]) {
                            shotTypeRatings[dominantType] = 0;
                            shotTypeCounts[dominantType] = 0;
                        }

                        // Average of all ratings for this shot type
                        const avgRating = (rating.descAccuracy + rating.shotTypeMatch + rating.accessibility) / 3;
                        shotTypeRatings[dominantType] += avgRating;
                        shotTypeCounts[dominantType]++;
                    }
                });

                // Calculate average for each shot type
                Object.keys(shotTypeRatings).forEach(type => {
                    shotTypeRatings[type] = shotTypeRatings[type] / shotTypeCounts[type];
                });

                // Get dominant shot type for current spot
                const dominantType = Object.keys(spot.shotTypes).reduce((a, b) => 
                    spot.shotTypes[a] > spot.shotTypes[b] ? a : b
                );

                // Apply learning algorithm
                if (shotTypeRatings[dominantType]) {
                    const avgRating = shotTypeRatings[dominantType];
                    const adjustedScore = baseScore * (avgRating / 3); // Normalized around 3 stars
                    return Math.round(Math.max(1, Math.min(100, adjustedScore)));
                }

                return baseScore;
            }

            // Render functions
            function render() {
                const content = document.getElementById('content');
                
                if (state.selectedSpot) {
                    content.innerHTML = renderSpotDetail();
                    initializeMap();
                } else if (state.currentTab === 'planner') {
                    content.innerHTML = renderTripPlanner();
                    if (state.spots.length > 0 && state.showSummaryMap) {
                        initializeSummaryMap();
                    }
                } else if (state.currentTab === 'upcoming') {
                    content.innerHTML = renderUpcoming();
                } else if (state.currentTab === 'log') {
                    content.innerHTML = renderFlightLog();
                }

                attachEventListeners();
            }

            function renderTripPlanner() {
                // Sort spots by adjusted risk score (learning algorithm applied)
                const spotsWithAdjustedScores = state.spots.map(spot => ({
                    ...spot,
                    adjustedScore: getAdjustedRiskScore(spot)
                })).sort((a, b) => b.adjustedScore - a.adjustedScore);

                const displaySpots = state.showFavoritesOnly
                    ? spotsWithAdjustedScores.filter(s => state.favorites.includes(s.id))
                    : spotsWithAdjustedScores;

                return `
                    <div class="x10-badge">
                        <div class="x10-title">🚁 Skydio X10 Optimized</div>
                        <div class="x10-features">
                            <span class="feature-tag">🌙 Nightsense</span>
                            <span class="feature-tag">🛡 Elite Avoidance</span>
                            <span class="feature-tag">📡 BVLOS Ready</span>
                            <span class="feature-tag">🎯 Part 107 Certified</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="input-group">
                            <label>📍 Destination</label>
                            <input type="text" id="destinationInput" placeholder="Enter city, hotel, or landmark" value="${state.destination}">
                        </div>
                        <button class="btn" id="findSpotsBtn">Find Spots</button>
                    </div>

                    ${state.spots.length > 0 ? `
                        <div class="map-toggle-group">
                            <button class="map-toggle-btn ${state.showSummaryMap ? 'active' : ''}" id="showMapBtn">🗺 Map</button>
                            <button class="map-toggle-btn ${!state.showSummaryMap ? 'active' : ''}" id="showListBtn">📋 List</button>
                        </div>

                        ${state.showSummaryMap ? `
                            <div class="summary-map-container" id="summaryMapContainer">
                                <div class="map-loading">Loading map...</div>
                            </div>
                        ` : ''}

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="font-size: 18px; font-weight: 700; color: #1e3c72; margin: 0;">
                                📍 ${state.showFavoritesOnly ? 'Favorite' : 'Recommended'} Spots
                            </h2>
                            <button class="toggle-favorites-btn ${state.showFavoritesOnly ? 'active' : ''}" id="toggleFavoritesBtn">
                                ${state.showFavoritesOnly ? '★ Favorites' : '☆ All Spots'}
                            </button>
                        </div>

                        ${displaySpots.length === 0 ? `
                            <div class="card" style="text-align: center; padding: 40px 20px;">
                                <p style="color: #666;">No favorite spots yet. Star some locations to save them!</p>
                            </div>
                        ` : displaySpots.map(spot => {
                            const riskScore = spot.adjustedScore;
                            const riskClass = riskScore >= 75 ? 'high' : riskScore >= 50 ? 'medium' : 'low';
                            const riskLabel = riskScore >= 75 ? 'Clear' : riskScore >= 50 ? 'Caution' : 'Review';
                            const riskIcon = riskScore >= 75 ? '✓' : '⚠';
                            
                            return `
                                <div class="spot-card" data-spot-id="${spot.id}">
                                    <img src="${spot.imageUrl}" alt="${spot.name}" class="spot-image">
                                    <div class="risk-badge ${riskClass}">
                                        ${riskIcon} ${riskScore} ${riskLabel}
                                    </div>
                                    <button class="favorite-star ${state.favorites.includes(spot.id) ? 'active' : ''}" 
                                            data-spot-id="${spot.id}" id="favBtn${spot.id}">
                                        ${state.favorites.includes(spot.id) ? '★' : '☆'}
                                    </button>
                                    <div class="spot-info">
                                        <div class="spot-name">${spot.name}</div>
                                        <div class="spot-desc">${spot.description}</div>
                                        <div class="spot-distance">📍 ${spot.distance} away</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    ` : ''}
                `;
            }

            function renderSpotDetail() {
                const spot = state.spots.find(s => s.id === state.selectedSpot);
                if (!spot) return '';

                const riskScore = getAdjustedRiskScore(spot);
                const riskClass = riskScore >= 75 ? '' : riskScore >= 50 ? 'caution' : 'no-go';
                const riskLabel = riskScore >= 75 ? 'Clear to Fly' : riskScore >= 50 ? 'Caution' : 'Review Required';
                const isFavorite = state.favorites.includes(spot.id);

                return `
                    <button class="back-button" id="backBtn">← Back</button>
                    
                    <div class="card">
                        <div style="position: relative;">
                            <img src="${spot.imageUrl}" alt="${spot.name}" class="detail-image">
                            <button class="favorite-star ${isFavorite ? 'active' : ''}" 
                                    style="top: 15px; right: 15px;" data-spot-id="${spot.id}" id="detailFavBtn">
                                ${isFavorite ? '★' : '☆'}
                            </button>
                        </div>

                        <h2 style="font-size: 20px; font-weight: 700; color: #1e3c72; margin-bottom: 15px;">
                            ${spot.name}
                        </h2>

                        <div class="instruction-box">
                            <h4>🎯 Flight Instructions</h4>
                            <p>${spot.flightInstructions}</p>
                        </div>

                        ${spot.x10Advantage ? `
                            <div class="instruction-box" style="background: #f0e8ff; border-left-color: #6a11cb;">
                                <h4 style="color: #6a11cb;">✨ X10 Advantage</h4>
                                <p>${spot.x10Advantage}</p>
                            </div>
                        ` : ''}

                        <button class="btn" id="savePlanBtn" style="margin-bottom: 15px;">
                            📅 Save Flight Plan
                        </button>

                        <div class="detail-section">
                            <h3>🗺 Location Map</h3>
                            <div class="map-container" id="mapContainer">
                                <div class="map-loading">Loading map...</div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>⚠️ Risk Assessment - ${riskScore}/100</h3>
                            ${renderRiskCategories(spot)}
                        </div>

                        <div class="detail-section">
                            <h3>✈️ Airspace Details</h3>
                            <div class="risk-category">
                                <div style="margin-bottom: 10px;">
                                    <strong>Class:</strong> ${spot.airspaceDetails.class}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Ceiling:</strong> ${spot.airspaceDetails.ceiling}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>LAANC Required:</strong> ${spot.airspaceDetails.laancRequired}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>Grid System:</strong> ${spot.airspaceDetails.gridSystem}
                                </div>
                                <div>
                                    <strong>Nearest Airport:</strong> ${spot.airspaceDetails.nearestAirport}
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>📋 Regulations</h3>
                            ${spot.regulations.map(reg => `
                                <div class="risk-category" style="border-left: 3px solid ${reg.compliant ? '#28a745' : '#dc3545'};">
                                    <div style="font-weight: 600; margin-bottom: 5px;">${reg.authority}</div>
                                    <div style="font-size: 13px; color: #666;">${reg.rule}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="detail-section">
                            <h3>🌤 Weather Conditions</h3>
                            <div class="risk-category">
                                <div style="margin-bottom: 8px;">
                                    <strong>Conditions:</strong> ${spot.weatherConditions.conditions}
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>Wind:</strong> ${spot.weatherConditions.wind}
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>Visibility:</strong> ${spot.weatherConditions.visibility}
                                </div>
                                <div>
                                    <strong>Temperature:</strong> ${spot.weatherConditions.temp}
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>ℹ️ About This Spot</h3>
                            <p style="font-size: 14px; color: #666; line-height: 1.6">
                                ${spot.description}
                            </p>
                        </div>
                    </div>
                `;
            }

            function renderRiskCategories(spot) {
                const categories = [
                    { name: 'Airspace Clearance', score: 95, desc: 'No restrictions, LAANC approved' },
                    { name: 'Weather Conditions', score: 90, desc: 'Favorable winds, clear visibility' },
                    { name: 'Regulatory Compliance', score: 100, desc: 'All permits and waivers in place' },
                    { name: 'Environmental Hazards', score: 85, desc: 'Minimal obstacles, safe terrain' }
                ];

                return categories.map(cat => {
                    const scoreClass = cat.score >= 75 ? 'score-high' : cat.score >= 50 ? 'score-medium' : 'score-low';
                    return `
                        <div class="risk-category">
                            <div class="risk-cat-header">
                                <span class="risk-cat-name">${cat.name}</span>
                                <span class="risk-cat-score ${scoreClass}">${cat.score}</span>
                            </div>
                            <div class="risk-cat-bar">
                                <div class="risk-cat-fill" style="width: ${cat.score}%"></div>
                            </div>
                            <p class="risk-cat-desc">${cat.desc}</p>
                        </div>
                    `;
                }).join('');
            }

            function renderUpcoming() {
                if (state.upcomingFlights.length === 0) {
                    return `
                        <div class="empty-state">
                            <div class="empty-state-icon">📅</div>
                            <p class="empty-state-text">No upcoming flights scheduled.<br>Save a flight plan from the Trip Planner!</p>
                        </div>
                    `;
                }

                // Sort by date
                const sortedFlights = [...state.upcomingFlights].sort((a, b) => 
                    new Date(a.dateTime) - new Date(b.dateTime)
                );

                return `
                    <h2 style="font-size: 18px; font-weight: 700; color: #1e3c72; margin-bottom: 15px;">
                        📅 Upcoming Flights (${sortedFlights.length})
                    </h2>
                    ${sortedFlights.map(flight => {
                        const dt = new Date(flight.dateTime);
                        const formattedDate = dt.toLocaleString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit'
                        });

                        return `
                            <div class="flight-card">
                                <div class="flight-header">
                                    <div>
                                        <div class="flight-location">${flight.spotName}</div>
                                        <div class="flight-date">${formattedDate}</div>
                                    </div>
                                </div>
                                <div class="flight-details">
                                    ${flight.notes ? `<p><strong>Notes:</strong> ${flight.notes}</p>` : ''}
                                </div>
                                <div class="flight-actions">
                                    <button class="btn-small" data-action="viewspot" data-spot-id="${flight.spotId}">
                                        View Spot
                                    </button>
                                    <button class="btn-small secondary" data-action="markflown" data-flight-id="${flight.id}">
                                        Mark as Flown
                                    </button>
                                    <button class="btn-small danger" data-action="delete" data-flight-id="${flight.id}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            }

            function renderFlightLog() {
                return `
                    ${state.showAddFlight ? renderAddFlightForm() : renderFlightsList()}
                `;
            }

            function renderFlightsList() {
                if (state.flights.length === 0) {
                    return `
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p class="empty-state-text">No flights logged yet.<br>Start by adding your first flight!</p>
                        </div>
                        <button class="btn" id="addFlightBtn">
                            ➕ Log New Flight
                        </button>
                    `;
                }

                return `
                    <button class="btn" id="addFlightBtn" style="margin-bottom: 20px;">
                        ➕ Log New Flight
                    </button>

                    <h2 style="font-size: 18px; font-weight: 700; color: #1e3c72; margin-bottom: 15px;">
                        Flight History (${state.flights.length})
                    </h2>
                    ${state.flights.map(flight => {
                        const rating = state.ratings.find(r => r.flightId === flight.id);
                        
                        return `
                            <div class="flight-card">
                                <div class="flight-header">
                                    <div>
                                        <div class="flight-location">
                                            ${flight.location}
                                            ${rating ? '<span class="badge rated">★ Rated</span>' : '<span class="badge pending">⏳ Rate This</span>'}
                                        </div>
                                        <div class="flight-date">${flight.date}</div>
                                    </div>
                                </div>
                                <div class="flight-details">
                                    <p><strong>Duration:</strong> ${flight.duration}</p>
                                    ${flight.notes ? `<p><strong>Notes:</strong> ${flight.notes}</p>` : ''}
                                    ${flight.files.length > 0 ? `<p><strong>Files:</strong> ${flight.files.length} attached</p>` : ''}
                                </div>
                                ${!rating ? `
                                    <div class="flight-actions">
                                        <button class="btn-small" data-action="rate" data-flight-id="${flight.id}">
                                            ⭐ Rate This Flight
                                        </button>
                                    </div>
                                ` : `
                                    <div style="margin-top: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                        <div style="font-size: 13px; color: #666;">
                                            <strong>Your Rating:</strong> ${rating.descAccuracy}⭐ Description | ${rating.shotTypeMatch}⭐ Shots | ${rating.accessibility}⭐ Access
                                        </div>
                                    </div>
                                `}
                            </div>
                        `;
                    }).join('')}
                `;
            }

            function renderAddFlightForm() {
                return `
                    <div class="card">
                        <h2 style="font-size: 18px; font-weight: 700; color: #1e3c72; margin-bottom: 20px;">
                            Log New Flight
                        </h2>

                        <div class="input-group">
                            <label>Location</label>
                            <input type="text" id="flightLocation" placeholder="Where did you fly?" value="${state.newFlight.location}">
                        </div>

                        <div class="input-group">
                            <label>Date</label>
                            <input type="date" id="flightDate" value="${state.newFlight.date}">
                        </div>

                        <div class="input-group">
                            <label>Flight Duration</label>
                            <input type="text" id="flightDuration" placeholder="e.g., 25 minutes" value="${state.newFlight.duration}">
                        </div>

                        <div class="input-group">
                            <label>Notes (optional)</label>
                            <textarea id="flightNotes" rows="3" placeholder="Weather conditions, highlights, etc.">${state.newFlight.notes}</textarea>
                        </div>

                        <div class="input-group">
                            <label>Upload Files (photos, videos, telemetry)</label>
                            <div class="file-upload" id="fileUploadArea">
                                <input type="file" id="fileInput" multiple accept="image/*,video/*,.csv,.log">
                                <p>📁 Click to upload files</p>
                            </div>
                            ${state.newFlight.files.length > 0 ? `
                                <div class="file-list">
                                    ${state.newFlight.files.map(file => `
                                        <div class="file-item">
                                            <span>${file}</span>
                                            <button class="file-remove" data-file="${file}">✕</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button class="btn" id="saveFlightBtn">Save Flight</button>
                            <button class="btn btn-secondary" id="cancelFlightBtn">Cancel</button>
                        </div>
                    </div>
                `;
            }

            // Map initialization
            function initializeMap() {
                const spot = state.spots.find(s => s.id === state.selectedSpot);
                if (!spot) return;

                setTimeout(() => {
                    const mapContainer = document.getElementById('mapContainer');
                    if (!mapContainer) return;

                    if (typeof L === 'undefined') {
                        setTimeout(() => {
                            if (typeof L === 'undefined') {
                                mapContainer.innerHTML = '<div class="map-loading">Map loading...</div>';
                                setTimeout(() => {
                                    if (typeof L === 'undefined') {
                                        mapContainer.innerHTML = '<div class="map-loading">Map unavailable</div>';
                                        return;
                                    }
                                    renderMap(mapContainer, spot);
                                }, 500);
                                return;
                            }
                            renderMap(mapContainer, spot);
                        }, 500);
                        return;
                    }
                    renderMap(mapContainer, spot);
                }, 150);
            }

            function renderMap(container, spot) {
                try {
                    const map = L.map(container).setView([spot.coordinates.lat, spot.coordinates.lng], 14);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    L.marker([spot.coordinates.lat, spot.coordinates.lng]).addTo(map)
                        .bindPopup(spot.name).openPopup();
                } catch (error) {
                    console.error('Map error:', error);
                }
            }

            function initializeSummaryMap() {
                setTimeout(() => {
                    const mapContainer = document.getElementById('summaryMapContainer');
                    if (!mapContainer || typeof L === 'undefined') return;

                    if (state.summaryMapInstance) {
                        state.summaryMapInstance.remove();
                    }

                    try {
                        const bounds = state.spots.map(s => [s.coordinates.lat, s.coordinates.lng]);
                        const map = L.map(mapContainer).fitBounds(bounds, { padding: [50, 50] });
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(map);

                        state.spots.forEach(spot => {
                            L.marker([spot.coordinates.lat, spot.coordinates.lng])
                                .addTo(map)
                                .bindPopup(spot.name);
                        });

                        state.summaryMapInstance = map;
                    } catch (error) {
                        console.error('Summary map error:', error);
                    }
                }, 150);
            }

            // Event handlers
            function attachEventListeners() {
                // Tab switching
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        state.currentTab = e.target.dataset.tab;
                        render();
                    });
                });

                // Find spots button
                const findSpotsBtn = document.getElementById('findSpotsBtn');
                if (findSpotsBtn) {
                    findSpotsBtn.addEventListener('click', () => {
                        const input = document.getElementById('destinationInput');
                        if (input && input.value) {
                            state.destination = input.value;
                            state.spots = scenicSpots;
                            render();
                        }
                    });
                }

                // Toggle favorites filter
                const toggleFavoritesBtn = document.getElementById('toggleFavoritesBtn');
                if (toggleFavoritesBtn) {
                    toggleFavoritesBtn.addEventListener('click', () => {
                        state.showFavoritesOnly = !state.showFavoritesOnly;
                        render();
                    });
                }

                // Map/List view toggle
                const showMapBtn = document.getElementById('showMapBtn');
                const showListBtn = document.getElementById('showListBtn');
                if (showMapBtn) {
                    showMapBtn.addEventListener('click', () => {
                        state.showSummaryMap = true;
                        render();
                    });
                }
                if (showListBtn) {
                    showListBtn.addEventListener('click', () => {
                        state.showSummaryMap = false;
                        if (state.summaryMapInstance) {
                            state.summaryMapInstance.remove();
                            state.summaryMapInstance = null;
                        }
                        render();
                    });
                }

                // Favorite star buttons
                document.querySelectorAll('.favorite-star').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const spotId = parseInt(e.currentTarget.dataset.spotId);
                        toggleFavorite(spotId);
                    });
                });

                // Spot cards
                document.querySelectorAll('.spot-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const spotId = parseInt(e.currentTarget.dataset.spotId);
                        state.selectedSpot = spotId;
                        render();
                    });
                });

                // Back button
                const backBtn = document.getElementById('backBtn');
                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        state.selectedSpot = null;
                        render();
                    });
                }

                // Save flight plan button
                const savePlanBtn = document.getElementById('savePlanBtn');
                if (savePlanBtn) {
                    savePlanBtn.addEventListener('click', () => {
                        showSavePlanModal();
                    });
                }

                // Upcoming flight actions
                document.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        const flightId = e.target.dataset.flightId;
                        const spotId = e.target.dataset.spotId;

                        if (action === 'viewspot') {
                            state.currentTab = 'planner';
                            state.selectedSpot = parseInt(spotId);
                            render();
                        } else if (action === 'markflown') {
                            markFlightAsFlown(flightId);
                        } else if (action === 'delete') {
                            deleteUpcomingFlight(flightId);
                        } else if (action === 'rate') {
                            showRatingModal(flightId);
                        }
                    });
                });

                // Add flight button
                const addFlightBtn = document.getElementById('addFlightBtn');
                if (addFlightBtn) {
                    addFlightBtn.addEventListener('click', () => {
                        state.showAddFlight = true;
                        render();
                    });
                }

                // Save flight button
                const saveFlightBtn = document.getElementById('saveFlightBtn');
                if (saveFlightBtn) {
                    saveFlightBtn.addEventListener('click', () => {
                        const location = document.getElementById('flightLocation').value;
                        const date = document.getElementById('flightDate').value;
                        const duration = document.getElementById('flightDuration').value;
                        const notes = document.getElementById('flightNotes').value;

                        if (location && date && duration) {
                            state.flights.unshift({
                                id: Date.now(),
                                location,
                                date,
                                duration,
                                notes,
                                files: [...state.newFlight.files],
                                spotData: null
                            });
                            saveToStorage('flights', state.flights);
                            state.showAddFlight = false;
                            state.newFlight = { location: '', date: '', duration: '', notes: '', files: [] };
                            render();
                        } else {
                            alert('Please fill in all required fields');
                        }
                    });
                }

                // Cancel flight button
                const cancelFlightBtn = document.getElementById('cancelFlightBtn');
                if (cancelFlightBtn) {
                    cancelFlightBtn.addEventListener('click', () => {
                        state.showAddFlight = false;
                        state.newFlight = { location: '', date: '', duration: '', notes: '', files: [] };
                        render();
                    });
                }

                // File upload
                const fileUploadArea = document.getElementById('fileUploadArea');
                const fileInput = document.getElementById('fileInput');
                if (fileUploadArea && fileInput) {
                    fileUploadArea.addEventListener('click', () => {
                        fileInput.click();
                    });

                    fileInput.addEventListener('change', (e) => {
                        const files = Array.from(e.target.files);
                        const fileNames = files.map(f => f.name);
                        state.newFlight.files = [...state.newFlight.files, ...fileNames];
                        render();
                    });
                }

                // File remove buttons
                document.querySelectorAll('.file-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const fileName = e.target.dataset.file;
                        state.newFlight.files = state.newFlight.files.filter(f => f !== fileName);
                        render();
                    });
                });
            }

            // Helper functions
            function toggleFavorite(spotId) {
                const index = state.favorites.indexOf(spotId);
                if (index > -1) {
                    state.favorites.splice(index, 1);
                } else {
                    state.favorites.push(spotId);
                }
                saveToStorage('favorites', state.favorites);
                render();
            }

            function showSavePlanModal() {
                const spot = state.spots.find(s => s.id === state.selectedSpot);
                if (!spot) return;

                const modal = document.getElementById('savePlanModal');
                const content = document.getElementById('savePlanContent');

                content.innerHTML = `
                    <div class="input-group">
                        <label>Flight Date & Time</label>
                        <input type="datetime-local" id="planDateTime">
                    </div>
                    <div class="input-group">
                        <label>Notes (optional)</label>
                        <textarea id="planNotes" rows="3" placeholder="Flight plan notes..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" id="confirmSavePlan">Save Plan</button>
                        <button class="btn btn-secondary" id="cancelSavePlan">Cancel</button>
                    </div>
                `;

                modal.classList.add('active');

                document.getElementById('confirmSavePlan').addEventListener('click', () => {
                    const dateTime = document.getElementById('planDateTime').value;
                    const notes = document.getElementById('planNotes').value;

                    if (dateTime) {
                        state.upcomingFlights.push({
                            id: Date.now(),
                            spotId: spot.id,
                            spotName: spot.name,
                            spotData: spot,
                            dateTime,
                            notes
                        });
                        saveToStorage('upcomingFlights', state.upcomingFlights);
                        modal.classList.remove('active');
                        alert('Flight plan saved!');
                    } else {
                        alert('Please select a date and time');
                    }
                });

                document.getElementById('cancelSavePlan').addEventListener('click', () => {
                    modal.classList.remove('active');
                });
            }

            function markFlightAsFlown(flightId) {
                const flightIndex = state.upcomingFlights.findIndex(f => f.id == flightId);
                if (flightIndex === -1) return;

                const flight = state.upcomingFlights[flightIndex];
                
                // Move to history
                state.flights.unshift({
                    id: Date.now(),
                    location: flight.spotName,
                    date: new Date(flight.dateTime).toLocaleDateString(),
                    duration: 'N/A',
                    notes: flight.notes,
                    files: [],
                    spotData: flight.spotData
                });

                // Remove from upcoming
                state.upcomingFlights.splice(flightIndex, 1);
                
                saveToStorage('upcomingFlights', state.upcomingFlights);
                saveToStorage('flights', state.flights);

                // Show rating modal immediately
                showRatingModal(state.flights[0].id);
            }

            function deleteUpcomingFlight(flightId) {
                if (confirm('Delete this flight plan?')) {
                    state.upcomingFlights = state.upcomingFlights.filter(f => f.id != flightId);
                    saveToStorage('upcomingFlights', state.upcomingFlights);
                    render();
                }
            }

            function showRatingModal(flightId) {
                const flight = state.flights.find(f => f.id == flightId);
                if (!flight) return;

                const modal = document.getElementById('ratingModal');
                const content = document.getElementById('ratingContent');

                state.currentRating = {
                    flightId: flight.id,
                    descAccuracy: 0,
                    shotTypeMatch: 0,
                    accessibility: 0,
                    wouldFlyAgain: null,
                    notes: ''
                };

                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <strong>Location:</strong> ${flight.location}
                    </div>

                    <div class="rating-group">
                        <label class="rating-label">Description Accuracy</label>
                        <div class="star-rating" id="descAccuracy">
                            ${[1,2,3,4,5].map(i => `<span class="star" data-rating="${i}">★</span>`).join('')}
                        </div>
                    </div>

                    <div class="rating-group">
                        <label class="rating-label">Shot Type Match</label>
                        <div class="star-rating" id="shotTypeMatch">
                            ${[1,2,3,4,5].map(i => `<span class="star" data-rating="${i}">★</span>`).join('')}
                        </div>
                    </div>

                    <div class="rating-group">
                        <label class="rating-label">Accessibility</label>
                        <div class="star-rating" id="accessibility">
                            ${[1,2,3,4,5].map(i => `<span class="star" data-rating="${i}">★</span>`).join('')}
                        </div>
                    </div>

                    <div class="rating-group">
                        <label class="rating-label">Would you fly here again?</label>
                        <div class="toggle-group">
                            <button class="toggle-btn" data-value="yes">Yes</button>
                            <button class="toggle-btn" data-value="no">No</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Additional Notes (optional)</label>
                        <textarea id="ratingNotes" rows="3" placeholder="Any additional feedback..."></textarea>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn" id="submitRating">Submit Rating</button>
                        <button class="btn btn-secondary" id="cancelRating">Cancel</button>
                    </div>
                `;

                modal.classList.add('active');

                // Star rating handlers
                document.querySelectorAll('.star-rating').forEach(group => {
                    const stars = group.querySelectorAll('.star');
                    stars.forEach(star => {
                        star.addEventListener('click', (e) => {
                            const rating = parseInt(e.target.dataset.rating);
                            const category = group.id;
                            state.currentRating[category] = rating;

                            // Update visual
                            stars.forEach((s, i) => {
                                s.classList.toggle('active', i < rating);
                            });
                        });
                    });
                });

                // Would fly again toggle
                document.querySelectorAll('[data-value]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('[data-value]').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        state.currentRating.wouldFlyAgain = e.target.dataset.value === 'yes';
                    });
                });

                // Submit rating
                document.getElementById('submitRating').addEventListener('click', () => {
                    const notes = document.getElementById('ratingNotes').value;
                    
                    if (state.currentRating.descAccuracy > 0 && 
                        state.currentRating.shotTypeMatch > 0 && 
                        state.currentRating.accessibility > 0 &&
                        state.currentRating.wouldFlyAgain !== null) {
                        
                        state.currentRating.notes = notes;
                        state.ratings.push({...state.currentRating});
                        saveToStorage('ratings', state.ratings);
                        
                        modal.classList.remove('active');
                        state.currentRating = null;
                        render();
                    } else {
                        alert('Please complete all ratings');
                    }
                });

                // Cancel rating
                document.getElementById('cancelRating').addEventListener('click', () => {
                    modal.classList.remove('active');
                    state.currentRating = null;
                });
            }

            // Initial render
            render();
        }
    </script>
</body>
</html>